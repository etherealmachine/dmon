<% content_for :navbar_center do %>
  <h1 class="text-xl font-bold text-white"><%= @game.pdfs.first.name %></h1>
<% end %>

<div class="flex h-[calc(100vh-4rem)]">
  <!-- Main Panel -->
  <div class="flex-1 overflow-y-auto p-8 bg-gray-50">
      <div class="max-w-4xl mx-auto">
        <!-- PDFs Grid -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-3">Game PDFs</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <% @game.pdfs.select(&:persisted?).each do |pdf| %>
                <%= link_to game_pdf_path(@game, pdf), class: "block bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-4 border border-gray-200" do %>
                  <div class="flex items-start space-x-3">
                    <!-- PDF Icon -->
                    <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                      <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                      </svg>
                    </div>

                    <!-- PDF Info -->
                    <div class="flex-1 min-w-0">
                      <h4 class="text-sm font-semibold text-gray-900 truncate mb-1">
                        <%= pdf.name %>
                      </h4>
                      <% if pdf.description.present? %>
                        <p class="text-xs text-gray-600 line-clamp-2">
                          <%= pdf.description %>
                        </p>
                      <% end %>
                      <% if pdf.images.any? %>
                        <p class="text-xs text-gray-500 mt-1">
                          <%= pdf.images.count %> images
                        </p>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              <% end %>

            <!-- Upload New PDF Card -->
            <div class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-4 border-2 border-dashed border-gray-300">
              <%= form_with(model: [@game, @game.pdfs.build], class: "h-full flex flex-col justify-center") do |f| %>
                <div class="flex-shrink-0 w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                  <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </div>
                <h4 class="text-sm font-semibold text-gray-900 text-center mb-3">Add New PDF</h4>
                <%= f.file_field :pdf,
                    accept: "application/pdf",
                    class: "block w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded file:border-0 file:text-xs file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-3" %>
                <%= f.submit "Add PDF", class: "w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors cursor-pointer text-sm" %>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Game Notes -->
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Game Notes</h3>
            <button onclick="document.getElementById('new-note-form').classList.toggle('hidden')" class="bg-green-500 hover:bg-green-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition-colors">
              + New Note
            </button>
          </div>

          <!-- New Note Form -->
          <div id="new-note-form" class="hidden mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <%= form_with(model: [@game, @game.game_notes.build], class: "space-y-3") do |f| %>
              <div>
                <%= f.label :note_type, "Note Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.select :note_type,
                    GameNote.note_types,
                    {},
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" %>
              </div>
              <div>
                <%= f.label :content, "Note Content", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_area :content,
                    placeholder: "Your note content (supports markdown)...",
                    rows: 6,
                    class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-sm" %>
              </div>
              <div class="flex gap-2">
                <%= f.submit "Create Note", class: "bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors cursor-pointer" %>
                <button type="button" onclick="document.getElementById('new-note-form').classList.add('hidden')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                  Cancel
                </button>
              </div>
            <% end %>
          </div>

          <% if @game.game_notes.any? %>
            <div class="space-y-4">
              <% @game.game_notes.chronological.each do |note| %>
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                  <!-- Note View -->
                  <div id="note-view-<%= note.id %>">
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-2">
                        <input type="checkbox"
                               class="context-checkbox rounded text-blue-600 focus:ring-blue-500"
                               data-gid="<%= note.to_global_id %>"
                               <%= 'checked' if params[:context_items]&.include?(note.to_global_id.to_s) %>>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= note.note_type == 'chat' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800' %>">
                          <%= note.note_type %>
                        </span>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">
                          <%= note.created_at.strftime("%b %d, %I:%M %p") %>
                        </span>
                        <button onclick="document.getElementById('note-view-<%= note.id %>').classList.add('hidden'); document.getElementById('note-edit-<%= note.id %>').classList.remove('hidden');" class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                          Edit
                        </button>
                        <%= button_to "Delete", game_game_note_path(@game, note), method: :delete, data: { confirm: "Are you sure?" }, class: "flex text-xs text-red-600 hover:text-red-800 font-medium" %>
                      </div>
                    </div>

                    <div>
                      <div class="text-sm text-gray-900 prose prose-sm max-w-none">
                        <%= markdown(note.content) %>
                      </div>
                    </div>

                    <% if note.stats.present? %>
                      <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-xs font-medium text-gray-500 uppercase mb-2">Stats</div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                          <% note.stats.each do |key, value| %>
                            <div class="p-2 bg-blue-50 rounded border border-blue-200">
                              <div class="text-xs text-gray-600 mb-0.5"><%= key %></div>
                              <div class="text-lg font-semibold text-gray-900"><%= value %></div>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>

                    <% if note.actions.present? %>
                      <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-xs font-medium text-gray-500 uppercase mb-2">Actions</div>
                        <div class="space-y-2">
                          <% note.actions.each_with_index do |action, index| %>
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200">
                              <div class="flex-1">
                                <div class="text-sm font-medium text-gray-900">
                                  <%= action['name'] || action[:name] || "Action #{index + 1}" %>
                                </div>
                                <% if (action['description'] || action[:description]).present? %>
                                  <div class="text-xs text-gray-600">
                                    <%= action['description'] || action[:description] %>
                                  </div>
                                <% end %>
                                <div class="text-xs text-gray-500 mt-1">
                                  Type: <%= action['type'] || action[:type] %>
                                </div>
                              </div>
                              <%= button_to "Execute", call_action_game_game_note_path(@game, note, action_index: index),
                                  method: :post,
                                  class: "ml-3 bg-purple-500 hover:bg-purple-600 text-white text-xs font-medium py-1 px-3 rounded transition-colors" %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>

                    <% if note.history.present? %>
                      <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-xs font-medium text-gray-500 uppercase mb-2">Action History</div>
                        <div class="space-y-2">
                          <% note.history.each_with_index do |history_item, index| %>
                            <div class="p-3 bg-gray-50 rounded border <%= history_item['success'] || history_item[:success] ? 'border-green-200' : 'border-red-200' %>">
                              <div class="flex items-start justify-between mb-1">
                                <div class="text-xs font-medium <%= history_item['success'] || history_item[:success] ? 'text-green-700' : 'text-red-700' %>">
                                  <%= (history_item['action_name'] || history_item[:action_name] || "Action #{index + 1}").upcase %>
                                </div>
                                <div class="text-xs text-gray-500">
                                  <%= Time.parse(history_item['timestamp'] || history_item[:timestamp]).strftime("%b %d, %I:%M %p") rescue "Unknown time" %>
                                </div>
                              </div>

                              <% if (history_item['action_description'] || history_item[:action_description]).present? %>
                                <div class="text-xs text-gray-600 mb-2">
                                  <%= history_item['action_description'] || history_item[:action_description] %>
                                </div>
                              <% end %>

                              <% if history_item['success'] || history_item[:success] %>
                                <% result = history_item['result'] || history_item[:result] %>
                                <% if result && (history_item['action_type'] || history_item[:action_type]) == 'roll' %>
                                  <div class="text-sm font-medium text-gray-900 mb-1">
                                    <%= result['dice_notation'] || result[:dice_notation] %>: <span class="text-green-600"><%= result['total'] || result[:total] %></span>
                                  </div>
                                  <div class="text-xs text-gray-600">
                                    <%= result['breakdown'] || result[:breakdown] %>
                                  </div>
                                <% end %>
                              <% else %>
                                <div class="text-xs text-red-600">
                                  Error: <%= history_item['error'] || history_item[:error] %>
                                </div>
                              <% end %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>

                  <!-- Note Edit Form -->
                  <div id="note-edit-<%= note.id %>" class="hidden">
                    <%= form_with(model: [@game, note], class: "space-y-3") do |f| %>
                      <div>
                        <%= f.label :note_type, "Note Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
                        <%= f.select :note_type,
                            GameNote.note_types,
                            {},
                            class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" %>
                      </div>
                      <div>
                        <%= f.label :content, "Note Content", class: "block text-sm font-medium text-gray-700 mb-1" %>
                        <%= f.text_area :content,
                            rows: 6,
                            class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm" %>
                      </div>
                      <div class="flex gap-2">
                        <%= f.submit "Update Note", class: "bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors cursor-pointer" %>
                        <button type="button" onclick="document.getElementById('note-edit-<%= note.id %>').classList.add('hidden'); document.getElementById('note-view-<%= note.id %>').classList.remove('hidden');" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors">
                          Cancel
                        </button>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center text-gray-500 py-8">
              <p>No notes yet.</p>
              <p class="text-sm mt-2">Notes created by the assistant will appear here.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

  <!-- Sidebar -->
  <div class="w-96 bg-white border-l border-gray-200 flex flex-col">
    <!-- Conversation History -->
    <div class="flex-1 overflow-y-auto p-4">
        <h3 class="text-lg font-semibold mb-4">Conversation</h3>

        <div class="space-y-3">
          <% if @game.agent&.conversation_history&.present? %>
            <% @game.agent.conversation_history.each do |message| %>
              <div class="<%= message['role'] == 'user' ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200' %> border rounded-lg p-3">
                <div class="mb-1">
                  <span class="text-xs font-medium <%= message['role'] == 'user' ? 'text-blue-600' : 'text-gray-600' %> uppercase">
                    <%= message['role'] %>
                  </span>
                </div>
                <div class="flex flex-col text-sm text-gray-700 whitespace-pre-wrap">
                  <%= markdown(message['content']) %>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-gray-500 text-sm text-center py-4">No messages yet. Start a conversation!</p>
          <% end %>
        </div>
      </div>

    <!-- Plan Display -->
    <% if @game.agent&.plan&.present? && @game.agent.plan.any? %>
      <div class="border-t border-gray-200 p-4 flex-shrink-0">
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Current Plan</h4>
        <div class="space-y-2">
          <% @game.agent.plan.each_with_index do |item, index| %>
            <div class="flex items-start gap-2 text-sm">
              <div class="flex-shrink-0 mt-0.5">
                <% if item["completed"] %>
                  <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% else %>
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                <% end %>
              </div>
              <span class="<%= item['completed'] ? 'text-gray-500 line-through' : 'text-gray-700' %>">
                <%= item["description"] %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Chat Input -->
    <div class="border-t border-gray-200 p-4 flex-shrink-0">
        <%= form_with(url: agent_game_path(@game), method: :post, class: "space-y-3", id: "chat-form") do |f| %>
          <div>
            <%= f.label :model, "AI Model", class: "block text-xs font-medium text-gray-700 mb-1" %>
            <%= f.select :model,
                options_for_select(GameAgent::ALLOWED_MODELS.map { |m| [m, m] }, @game.agent.model),
                {},
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm mb-3" %>
          </div>
          <div>
            <%= f.text_area :input,
                placeholder: "Ask anything...",
                rows: 3,
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none text-sm" %>
          </div>
          <%= f.submit "Send",
              class: "w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors cursor-pointer" %>
        <% end %>
    </div>
  </div>
</div>

<script>
  // Initialize UI handler for streaming agent responses
  window.AgentUI = {
    currentMessageElement: null,
    conversationContainer: null,
    isProcessing: false,

    init() {
      this.conversationContainer = document.querySelector('.space-y-3');

      // Subscribe to the agent channel
      const gameId = <%= @game.id %>;
      window.AgentChannel.subscribe(gameId);

      // Setup form submission
      const form = document.getElementById('chat-form');
      form.addEventListener('submit', (e) => this.handleFormSubmit(e));
    },

    handleFormSubmit(e) {
      e.preventDefault();

      if (this.isProcessing) {
        alert('Please wait for the current request to complete');
        return;
      }

      const form = e.target;
      const formData = new FormData(form);
      const input = formData.get('input');

      if (!input || input.trim() === '') {
        return;
      }

      // Add checked context items to the form data
      document.querySelectorAll('.context-checkbox:checked').forEach(checkbox => {
        formData.append('context_items[]', checkbox.dataset.gid);
      });

      this.isProcessing = true;
      this.disableForm(form);

      // Clear the input
      form.querySelector('textarea[name="input"]').value = '';

      // Submit via AJAX
      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('Request submitted:', data);
      })
      .catch(error => {
        console.error('Error:', error);
        this.handleError({ error: error.message });
        this.enableForm(form);
      });
    },

    disableForm(form) {
      form.querySelector('textarea[name="input"]').disabled = true;
      form.querySelector('input[type="submit"]').disabled = true;
      form.querySelector('input[type="submit"]').value = 'Processing...';
    },

    enableForm(form) {
      form.querySelector('textarea[name="input"]').disabled = false;
      form.querySelector('input[type="submit"]').disabled = false;
      form.querySelector('input[type="submit"]').value = 'Send';
      this.isProcessing = false;
    },

    handleUserMessage(data) {
      // User message is already in the conversation history, just log it
      console.log('User message:', data.content);
    },

    handleAssistantStart(data) {
      // Create a new assistant message bubble
      this.currentMessageElement = document.createElement('div');
      this.currentMessageElement.className = 'bg-gray-50 border-gray-200 border rounded-lg p-3';
      this.currentMessageElement.innerHTML = `
        <div class="mb-1">
          <span class="text-xs font-medium text-gray-600 uppercase">assistant</span>
        </div>
        <div class="text-sm text-gray-700 whitespace-pre-wrap streaming-content"></div>
      `;
      this.conversationContainer.appendChild(this.currentMessageElement);
      this.scrollToBottom();
    },

    handleContent(data) {
      if (!this.currentMessageElement) {
        this.handleAssistantStart({});
      }

      const contentDiv = this.currentMessageElement.querySelector('.streaming-content');
      contentDiv.textContent += data.content;
      this.scrollToBottom();
    },

    handleToolCallsStart(data) {
      const toolDiv = document.createElement('div');
      toolDiv.className = 'mt-2 p-2 bg-purple-50 border border-purple-200 rounded text-xs';
      toolDiv.innerHTML = `<span class="font-medium text-purple-700">Executing ${data.count} tool call(s)...</span>`;
      if (this.currentMessageElement) {
        this.currentMessageElement.appendChild(toolDiv);
      }
      this.scrollToBottom();
    },

    handleToolCall(data) {
      const toolDiv = document.createElement('div');
      toolDiv.className = 'mt-1 p-2 bg-purple-50 border border-purple-200 rounded text-xs';
      toolDiv.innerHTML = `<span class="font-medium text-purple-700">Tool: ${data.name}</span>`;
      if (this.currentMessageElement) {
        this.currentMessageElement.appendChild(toolDiv);
      }
      this.scrollToBottom();
    },

    handleToolResult(data) {
      // Optionally show tool results
      console.log('Tool result:', data.name, data.result);
    },

    handleToolCallsComplete(data) {
      const toolDiv = document.createElement('div');
      toolDiv.className = 'mt-2 p-2 bg-green-50 border border-green-200 rounded text-xs';
      toolDiv.innerHTML = `<span class="font-medium text-green-700">Tools executed successfully</span>`;
      if (this.currentMessageElement) {
        this.currentMessageElement.appendChild(toolDiv);
      }
      this.currentMessageElement = null; // Reset for next assistant message
      this.scrollToBottom();
    },

    handleJobComplete(data) {
      console.log('Job complete, reloading page...');
      // Reload the page to show updated conversation history, notes, and plan
      window.location.reload();
    },

    handleError(data) {
      console.error('Agent error:', data.error);

      const errorDiv = document.createElement('div');
      errorDiv.className = 'bg-red-50 border-red-200 border rounded-lg p-3';
      errorDiv.innerHTML = `
        <div class="mb-1">
          <span class="text-xs font-medium text-red-600 uppercase">error</span>
        </div>
        <div class="text-sm text-red-700">${this.escapeHtml(data.error)}</div>
      `;
      this.conversationContainer.appendChild(errorDiv);
      this.scrollToBottom();

      const form = document.getElementById('chat-form');
      this.enableForm(form);
    },

    scrollToBottom() {
      const container = this.conversationContainer.parentElement;
      container.scrollTop = container.scrollHeight;
    },

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', () => {
    window.AgentUI.init();
  });

  // Also initialize on Turbo page loads
  document.addEventListener('turbo:load', () => {
    window.AgentUI.init();
  });
</script>
