<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Agent Debug View</h1>
    <p class="text-gray-600">Game: <%= @game.id %></p>
    <%= link_to "Back to Game", @game, class: "text-blue-600 hover:text-blue-800" %>
  </div>

  <!-- Context String (System Prompt + Context) -->
  <div class="mb-8 bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4 text-blue-600">Context String (System Prompt + Context + Plan)</h2>
    <pre class="bg-gray-50 p-4 rounded overflow-x-auto whitespace-pre-wrap text-sm"><%= @context_string %></pre>
  </div>

  <!-- Context Messages -->
  <div class="mb-8 bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4 text-green-600">Context Messages (<%= @context_messages.length %>)</h2>
    <% if @context_messages.any? %>
      <% @context_messages.each_with_index do |msg, idx| %>
        <div class="mb-4 p-4 bg-green-50 rounded border-l-4 border-green-500">
          <div class="font-semibold text-green-700 mb-2">Message <%= idx + 1 %> - Role: <%= msg[:role] %></div>
          <pre class="text-sm whitespace-pre-wrap"><%= msg[:content] %></pre>
        </div>
      <% end %>
    <% else %>
      <p class="text-gray-500 italic">No context messages</p>
    <% end %>
  </div>

  <!-- Conversation History -->
  <div class="mb-8 bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4 text-purple-600">Conversation History (<%= @conversation_history.length %> messages)</h2>
    <% if @conversation_history.any? %>
      <% @conversation_history.each_with_index do |msg, idx| %>
        <div class="mb-4 p-4 rounded border-l-4 <%= case msg['role']
          when 'user' then 'bg-blue-50 border-blue-500'
          when 'assistant' then 'bg-purple-50 border-purple-500'
          when 'tool' then 'bg-yellow-50 border-yellow-500'
          when 'system' then 'bg-gray-50 border-gray-500'
          else 'bg-gray-50 border-gray-300'
          end %>">
          <div class="font-semibold mb-2 <%= case msg['role']
            when 'user' then 'text-blue-700'
            when 'assistant' then 'text-purple-700'
            when 'tool' then 'text-yellow-700'
            when 'system' then 'text-gray-700'
            else 'text-gray-600'
            end %>">
            <%= msg['role'].capitalize %> <%= idx + 1 %>
            <% if msg['tool_call_id'] %>
              <span class="text-xs">(Tool Call ID: <%= msg['tool_call_id'] %>)</span>
            <% end %>
          </div>

          <% if msg['content'].present? %>
            <div class="mb-2">
              <pre class="text-sm whitespace-pre-wrap"><%= msg['content'] %></pre>
            </div>
          <% end %>

          <% if msg['tool_calls'].present? %>
            <div class="mt-2">
              <div class="font-semibold text-sm mb-1">Tool Calls:</div>
              <% msg['tool_calls'].each do |tool_call| %>
                <div class="ml-4 mb-2 text-sm bg-white p-2 rounded">
                  <div class="font-mono text-xs text-purple-600"><%= tool_call['function']['name'] %></div>
                  <pre class="text-xs mt-1"><%= JSON.pretty_generate(JSON.parse(tool_call['function']['arguments'])) %></pre>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <p class="text-gray-500 italic">No conversation history yet</p>
    <% end %>
  </div>


  <!-- Tool Definitions -->
  <div class="mb-8 bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4 text-red-600">Tool Definitions (<%= @tool_definitions.length %>)</h2>
    <% @tool_definitions.each_with_index do |tool, idx| %>
      <div class="mb-4 p-4 bg-red-50 rounded">
        <div class="font-bold text-red-700 mb-2"><%= tool[:name] %></div>
        <div class="text-sm text-gray-700 mb-2"><%= tool[:description] %></div>
        <details class="text-xs">
          <summary class="cursor-pointer text-blue-600 hover:text-blue-800">View Parameters</summary>
          <pre class="mt-2 bg-white p-2 rounded"><%= JSON.pretty_generate(tool[:parameters]) %></pre>
        </details>
      </div>
    <% end %>
  </div>

  <!-- Stats -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-2xl font-bold mb-4">Statistics</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
      <div class="bg-blue-50 p-4 rounded">
        <div class="text-3xl font-bold text-blue-600"><%= @conversation_history.length %></div>
        <div class="text-sm text-gray-600">Conversation Messages</div>
      </div>
      <div class="bg-green-50 p-4 rounded">
        <div class="text-3xl font-bold text-green-600"><%= @context_messages.length %></div>
        <div class="text-sm text-gray-600">Context Messages</div>
      </div>
      <div class="bg-red-50 p-4 rounded">
        <div class="text-3xl font-bold text-red-600"><%= @tool_definitions.length %></div>
        <div class="text-sm text-gray-600">Available Tools</div>
      </div>
    </div>
  </div>
</div>
